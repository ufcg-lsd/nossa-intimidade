---
title: "Explorando a APi"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r, warning=FALSE}
library(tidyverse)
library(lubridate)
library(jsonlite)
library(zoo)
#devtools::install_github("juliasilge/silgelib")
library(silgelib)
theme_set(theme_roboto())
# These fonts must be installed locally on your computer for this theme to work: https://fonts.google.com/specimen/Roboto+Condensed and https://fonts.google.com/specimen/Roboto. 

source('../R/intimidade.R')
```

# Counts

```{r ler}
counts_raw = fromJSON("http://150.165.85.12:41205/get_today_people_count") %>% 
    as.tibble() 

counts = counts_raw %>% 
    transmute(t = ymd_hms(timestamps), 
              macs = data)
```

```{r filtrar}
macs_fixos = counts %>% 
    filter(hour(t) %in% 1:4) %>% 
    summarise(fixos = quantile(macs, 0.8)[[1]])

counts = counts %>% 
    group_by(t) %>% 
    mutate(pessoas = max(0, macs - macs_fixos$fixos)) %>% 
    ungroup() %>% 
    mutate(pessoas_mm = rollapply(pessoas, 3 , mean, align='right', fill=NA))

```

# Quantos somos?

```{r}
counts %>% 
    filter(!is.na(pessoas_mm)) %>% 
    ggplot(aes(x = t, y = pessoas_mm)) + 
    geom_line(color = "grey") + 
    geom_point(color = "darkred") + 
    #geom_smooth(method = "loess", se = F) + 
    labs(title = "Movimento, pessoas e vida no hall",
         subtitle = "Quantas pesssoas ao longo do tempo?") 
```

# Por endereÃ§o

```{r carrega}
vistos_raw = fromJSON("http://150.165.85.12:41205/get_last_minutes?m=129600") %>% 
    as.tibble() %>% 
    filter(identifier == "LSD") %>% 
    select(-3)

vistos = vistos_raw %>% 
    mutate(t = ymd_hms(timestamp)) %>% 
    select(-timestamp)
```

```{r filtra}
perenes = get_macs_perenes(vistos)

vistos = vistos %>% 
    filter(!(mac %in% perenes$mac))
```

```{r "ao longo do dia"}
contagem = conta_macs(vistos, 5)

p = contagem %>% 
    ggplot(aes(x = periodo, y = n)) + 
    geom_line()
p
#library(plotly)
#ggplotly(p)
```


```{r}
contagem %>% 
    ggplot(aes(x = periodo, y = n, group = )) + 
    geom_line()
```

