---
title: "R Notebook"
output: html_notebook
---

```{r, echo=FALSE}

library(dplyr)
library(ggplot2)
library(lubridate)
library(jsonlite)

source("../R/intimidade.R")

```

```{r}
last_month <- fromJSON("http://150.165.85.12:41205/get_last_minutes?m=43200")

last_month_LSD <- last_month %>%
    filter(identifier == "LSD") %>%
    mutate(t = ymd_hms(timestamp)) %>%
    select(-3, -identifier)

macs_perenes <- get_macs_perenes(last_month_LSD)

last_filtered_month_LSD <- last_month_LSD %>%
    filter(!(mac %in% macs_perenes$mac))

```


```{r}
early_birds <- filtra_diferentoes(last_filtered_month_LSD, 4, 8)
night_owls <- rbind(filtra_diferentoes(last_filtered_month_LSD, 20, 23),
                    filtra_diferentoes(last_filtered_month_LSD, 0, 4))

filtra_presentes(early_birds)
filtra_presentes(night_owls)
```

```{r}
early_workers <- filtra_diferentoes(last_filtered_month_LSD, 4, 16)
night_workers <- rbind(filtra_diferentoes(last_filtered_month_LSD, 17, 23),
                    filtra_diferentoes(last_filtered_month_LSD, 0, 4))

filtra_atividade(early_workers)
filtra_atividade(night_workers)
```

```{r}

db <- read.csv('../data/db_lsd_sem_perenes.csv')

intimidade <- read.csv('../data/intimidade.csv')
names(intimidade) <- c('timestamp', 'nome', 'mac', 'mensagem')
intimidade <- intimidade %>%
    select(-1) %>%
    mutate(mac = tolower(mac))
```


```{r}
atividade_conhecidos <- conhecidos %>% 
    mutate(t = ymd_hms(t)) %>%
    group_by(nome, dia_f = floor_date(t, unit = "day")) %>%
    filter(t == first(t)) %>% 
    ungroup() %>% 
    mutate(dia = wday(t)) %>%
    group_by(nome, dia) %>% 
    count()

atividade_por_pessoa <- atividade_conhecidos %>%
    group_by(nome) %>%
    summarise(somadias = sum(n))
```

```{r}
 atividade_conhecidos %>%
    merge(atividade_por_pessoa, by = 'nome') %>%
    mutate(taxa_atividade = n / somadias) %>%
    ggplot(aes(x = dia, y = taxa_atividade)) + 
    geom_line() + facet_wrap(~nome)
```


```{r}
atividade_conhecidos <- conhecidos %>% 
    mutate(t = ymd_hms(t)) %>%
    group_by(mensagem, dia_f = floor_date(t, unit = "day")) %>%
    filter(t == first(t)) %>% 
    ungroup() %>% 
    mutate(dia = wday(t)) %>%
    group_by(mensagem, dia) %>% 
    count()

atividade_por_pessoa <- atividade_conhecidos %>%
    group_by(mensagem) %>%
    summarise(somadias = sum(n))
```

```{r}
 atividade_conhecidos %>%
    merge(atividade_por_pessoa, by = 'mensagem') %>%
    mutate(taxa_atividade = n / somadias) %>%
    ggplot(aes(x = dia, y = taxa_atividade)) + 
    geom_line() + facet_wrap(~mensagem) + labs(title = "Dias favoritos pra visitar o lab", y = 'FrequÃªncia (%)', x = "Dia da semana") + theme_minimal()
```
