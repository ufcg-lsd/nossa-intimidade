---
title: "Explorando a APi"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r, warning=FALSE}
library(tidyverse)
library(lubridate)
library(jsonlite)
library(zoo)
#devtools::install_github("juliasilge/silgelib")
library(silgelib)
#install.packages("viridis")
library(viridis)
theme_set(theme_roboto())
# These fonts must be installed locally on your computer for this theme to work: https://fonts.google.com/specimen/Roboto+Condensed and https://fonts.google.com/specimen/Roboto. 

source('../R/intimidade.R')
```

# Counts

```{r ler}
counts_raw = fromJSON("http://150.165.85.12:41205/get_today_people_count") %>% 
    as.tibble() 

counts = counts_raw %>% 
    transmute(t = ymd_hms(timestamps), 
              macs = data)
```

```{r filtrar}
macs_fixos = counts %>% 
    filter(hour(t) %in% 1:4) %>% 
    summarise(fixos = quantile(macs, 0.8)[[1]])

counts = counts %>% 
    group_by(t) %>% 
    mutate(pessoas = max(0, macs - macs_fixos$fixos)) %>% 
    ungroup() %>% 
    mutate(pessoas_mm = rollapply(pessoas, 3 , mean, align='right', fill=NA))

```

# Quantos somos?

```{r}
counts %>% 
    filter(!is.na(pessoas_mm)) %>% 
    ggplot(aes(x = t, y = pessoas_mm)) + 
    geom_line(color = "grey") + 
    geom_point(color = "darkred") + 
    #geom_smooth(method = "loess", se = F) + 
    labs(title = "Movimento, pessoas e vida no hall",
         subtitle = "Quantas pesssoas ao longo do tempo?") 
```

# Por endereço

```{r carrega_da_api}
# vistos_raw = fromJSON("http://150.165.85.12:41205/get_last_minutes?m=129600") %>% 
#     as.tibble() %>% 
#     filter(identifier == "LSD") %>% 
#     select(-3)
# 
# vistos = vistos_raw %>% 
#     mutate(t = ymd_hms(timestamp)) %>% 
#     select(-timestamp)
# perenes = get_macs_perenes(vistos)
# 
# vistos = vistos %>% 
#     filter(!(mac %in% perenes$mac))

```

```{r}
vistos = read_csv("../data/db_lsd_sem_perenes.csv", 
                  col_types = cols(
                    t = col_datetime(format = ""),
                    mac = col_character(),
                    signal = col_integer()
                ))
# vistos = vistos %>% 
#     mutate(t = ymd_hms(t))
```


```{r "ao longo do dia"}
# contagem = conta_macs(vistos, 5)
# write_csv(contagem, "../data/contagem_lsd.csv")
contagem = read_csv("../data/contagem_lsd.csv")

suavizada = contagem %>% 
    mutate(dia = floor_date(periodo, unit = "day"), 
           hora = (hour(periodo) * 60 + minute(periodo)) / 60, 
           n_smooth = rollapply(n, 15 , mean, align='right', fill=NA)) %>% 
    group_by(dia) %>% 
    filter(n() > 12 * 12) %>% # 12 horas com obs a cada 5 mins
    ungroup() %>% 
    filter(complete.cases(.))

```


```{r}
p = suavizada %>% 
    ggplot(aes(x = hora, y = n_smooth, group = dia)) + 
    geom_line(alpha = .2, size = .6, color = "darkred") + 
    scale_x_continuous(breaks = c(8, 12, 16, 18, 20), limits = c(7, 23)) + 
    labs(x = "hora do dia", 
         y = "pessoas", 
         title = "Nossos dias",
         subtitle = "Cada linha é um dia, cada dia uma história")  
    
p

```

```{r}
library(scales)
p = suavizada %>% 
    mutate(dia_semana = wday(dia, label = TRUE)) %>% 
    ggplot(aes(x = hora, y = n_smooth, group = dia)) + 
    scale_x_continuous(breaks = c(8, 12, 16, 18, 20), limits = c(7, 23)) + 
    geom_line(alpha = .2, size = .5, color = "darkred") + 
    facet_wrap( ~ dia_semana) + 
    #xlim(6, 24) + 
    labs(x = "hora do dia", 
         y = "pessoas", 
         title = "Nossos dias",
         subtitle = "Cada linha é um dia, cada dia uma história")  
    
p

```


Procurar: 16-09-2016 15h30
27-09-2016 17h30
18-10-2016 17h

09-12-2016  20h   20 anos?
17-06-2016  20h   SJ?

17-10-2016

17-02-2016 21h


```{r}
suavizada %>% 
    ggplot(aes(x = hora, y = n_smooth, group = dia)) + 
    geom_line(alpha = .6, size = .6, colour = "yellow") +
    scale_x_continuous(breaks = c(8, 12, 16, 18, 20), limits = c(7, 23)) + 
    geom_line(data = filter(suavizada, date(dia) == ymd("2016-06-17")), alpha = 1, size = 2, colour = "darkorange") +
    labs(x = "hora do dia", 
         y = "pessoas", 
         title = "Nossos dias",
         subtitle = "Cada linha é um dia, cada dia uma história")  
```

```{r}
suavizada %>% 
    filter(year(dia) == 2016) %>% 
    ggplot(aes(x = day(dia), 
               fill = sqrt(n_smooth), 
               y = hour(periodo))) + 
    geom_tile() +
    facet_wrap(~month(dia)) + 
    scale_fill_viridis() + 
    xlim(7, 22) + 
    labs(x = "dia", 
         y = "hora", 
         title = "Nossos dias",
         subtitle = "Cada linha é um dia, cada dia uma história")  
```

```{r}
suavizada %>% 
    filter(year(dia) == 2016) %>%
    mutate(mes = month(dia), 
           hora = floor(hour(periodo)), 
           dia_semana = wday(dia, label = T)) %>% 
    group_by(mes, dia_semana, hora) %>% 
    summarise(n_smooth = mean(n_smooth)) %>% 
    ggplot(aes(x = hora, 
               fill = sqrt(n_smooth), 
               y = dia_semana)) + 
    geom_tile() +
    coord_flip() + 
    facet_wrap(~mes) +
    xlim(7, 23) + 
    scale_fill_viridis(option = "inferno") + 
    labs(x = "do mês", 
         y = "da semana", 
         title = "Nossos dias",
         subtitle = "Cada linha é um dia, cada dia uma história")  
```


## Almoço 

```{r}
suavizada %>% 
    filter(hora > 11.8, hora < 14, year(periodo) < 2017) %>% 
    group_by(quando = floor_date(periodo, unit = "week")) %>% 
    summarise(comum = mean(n)) %>% 
    ggplot(aes(x = quando, y = comum)) + 
    geom_point() + 
    geom_smooth()
```

# Relógio, versão dia

```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    ggplot(aes(x = hora, y = n_smooth, group = dia, color = month(periodo))) + 
    geom_line(alpha = .13, size = .7) +
    scale_color_viridis(NULL, direction = -1, begin = 0.1, end = 1, option = "B") +
    scale_x_continuous(breaks = seq(8, 19, 1), limits = c(7, 19)) +
    scale_y_sqrt() +
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size=23, family = "Helvetica", face = "bold", colour = "gray30"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank())
```


# Relógio, versão noite

```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    ggplot(aes(x = hora, y = n_smooth, group = dia, color = month(periodo))) + 
    geom_line(alpha = .13, size = .7) +
    scale_color_viridis(NULL, direction = -1, begin = 0.1, end = 1, option = "D") +
    scale_x_continuous(breaks = seq(8, 19, 1), limits = c(7, 19)) +
    scale_y_sqrt() +
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size=23, family = "Helvetica", face = "bold", colour = "gray30"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank())
```


# Relógio sem a legenda

```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    ggplot(aes(x = hora, y = n_smooth, group = dia, color = month(periodo))) + 
    geom_hline(alpha = 0.7, yintercept = c(5, 20, 45, 75, 115), colour = "gray80", size = 1) +
    geom_line(alpha = .15, size = .7) +
    annotate("text", label = "5", x = 20, y = 5, size = 7, family = "Helvetica", fontface = "bold", color = "gray70") +
    annotate("text", label = "15", x = 20, y = 20, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "45", x = 20, y = 45, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "75", x = 20, y = 75, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "5", x = 14, y = 5, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "15", x = 14, y = 20, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "45", x = 14, y = 45, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "75", x = 14, y = 75, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "5", x = 11, y = 5, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "15", x = 11, y = 20, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "45", x = 11, y = 45, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "75", x = 11, y = 75, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "5", x = 17, y = 5, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "15", x = 17, y = 20, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "45", x = 17, y = 45, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "75", x = 17, y = 75, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    scale_color_viridis(NULL, direction = -1, begin = 0.1, option = "D") +
    scale_x_continuous(breaks = seq(9, 20, 1), limits = c(8, 20)) +
    scale_y_sqrt() + 
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size = 54, family = "Helvetica", face = "bold", colour = "gray60"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          panel.grid = element_blank(),
                          legend.position = "none")
```



```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    mutate(mes = cut(month(periodo), breaks = 4, labels = c("Jan-Mar", "Abr-Jun", "Jul-Set", "Out-Dez"))) %>%
    ggplot(aes(x = hora, y = n_smooth, group = dia, color = mes)) + 
    geom_hline(alpha = 0.7, yintercept = c(5, 20, 45, 75, 115), colour = "gray80", size = 1) +
    geom_line(alpha = .15, size = .7) +
    annotate("text", label = "5", x = 20, y = 5, size = 7, family = "Helvetica", fontface = "bold", color = "gray70") +
    annotate("text", label = "15", x = 20, y = 20, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "45", x = 20, y = 45, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    annotate("text", label = "75", x = 20, y = 75, size = 7, family = "Helvetica", fontface = "bold", color = "gray60") +
    scale_color_viridis(NULL, direction = -1, begin = 0.1, option = "D", discrete = T) +
    scale_x_continuous(breaks = seq(9, 20, 1), limits = c(8, 20)) +
    scale_y_sqrt() + 
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size = 54, family = "Helvetica", face = "bold", colour = "gray60"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          panel.grid = element_blank(),
                          legend.position = c(0.5, 0.21),
                          legend.background = element_rect(color = "gray80", linetype = "solid")) +
    guides(color = guide_legend(override.aes = list(size=3, alpha = 1)))
```


```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    group_by(hour(periodo)) %>%
    mutate(atividade.min = quantile(n_smooth, probs = 0.1),
           atividade.max = quantile(n_smooth, probs = 0.7),
           atividade.media = median(n_smooth)) %>%
    ggplot(aes(x = hora, ymin = atividade.min, ymax = atividade.max, color = atividade.media)) +
    geom_linerange(size = 1.3, alpha = 0.75) +
    scale_y_sqrt(limits = c(-5, 50)) +
    scale_x_continuous(breaks = seq(9, 20, 1), limits = c(8, 20)) +
    scale_color_viridis(NULL, option = "A", direction = -1) +
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size = 16, family = "Helvetica", colour = "gray60"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          panel.grid.major.x = element_blank())
```


```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    group_by(hora) %>%
    summarise(atividade.min = quantile(n_smooth, probs = 0.1),
           atividade.max = quantile(n_smooth, probs = 0.9),
           atividade.media = median(n_smooth)) %>%
    ggplot(aes(x = hora, ymin = atividade.min, ymax = atividade.max, color = atividade.media)) +
    geom_linerange(size = 1.3, alpha = 0.75) +
    scale_y_sqrt(limits = c(-5, 50)) +
    scale_x_continuous(breaks = seq(9, 20, 1), limits = c(8, 20)) +
    scale_color_viridis(NULL, option = "A", end = 0.95) +
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size = 54, family = "Helvetica", face = "bold", colour = "gray60"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          panel.grid = element_blank(),
                          legend.position = c(0.5, 0.21),
                          legend.background = element_rect(color = "gray80", linetype = "solid"))
```



```{r}
suavizada %>%
    filter(year(periodo) == 2016) %>%
    group_by(mes = month(periodo, label = T), hora) %>%
    summarise(atividade.min = quantile(n_smooth, probs = 0.1),
           atividade.max = quantile(n_smooth, probs = 0.9),
           atividade.media = median(n_smooth)) %>%
    ggplot(aes(x = hora, ymin = atividade.min, ymax = atividade.max, color = atividade.media)) + facet_wrap(~mes) +
    geom_linerange(size = 1.3, alpha = 0.75) +
    scale_y_sqrt() +
    scale_x_continuous(breaks = seq(9, 20, 1), limits = c(8, 20)) +
    scale_color_viridis(NULL, option = "A", end = 0.9) +
    coord_polar() + theme(axis.title.x = element_blank(),
                          axis.text.x = element_text(size = 16, family = "Helvetica", colour = "gray60"),
                          axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          panel.grid = element_blank())
```

